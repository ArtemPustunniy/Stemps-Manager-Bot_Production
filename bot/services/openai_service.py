import json
import logging
from typing import List, Dict
from bot.config.settings import OPENAI_API_KEY
from openai import AsyncOpenAI

openai_client = AsyncOpenAI(api_key=OPENAI_API_KEY)


async def get_commands_from_llm(instruction: str) -> List[Dict]:
    try:
        prompt = (
            """Ты помощник, преобразующий текст в JSON-команды.
            Твоя задача — анализировать инструкцию и сделать с ней следующее:

            В запросе могут приходить различные названия колонок таблицы. То есть каждый человек может наывать их по-разному.
            Вот примерные варианты того, как могут быть названы колонки в запросе на добавление новой записи:
            **Клиент** - [ОАО, ЗАО, ПАО, организация, физическое лицо, юридическое лицо, компания], а так же все грамматические формы этих слов в русском языке
            **Курс** - [наш продукт, продукт], а так же все грамматические формы этих слов в русском языке
            **Сумма** - [стоимость, стоимость курсов, цена, ценник, цена курса, цена курсов, прайс]. Так же если в запросе пришли фразы по типу [курсы стоят, по цене, стоимостью], а дальше стоят цифры, то следует расценивать это как данные для графы "сумма"
            **Статус оплаты** - [подтверждение оплаты]. Если в запросе пришли фразы по типу [клиент оплатил, оплата подтвержена], то есть фразы, которые имеют значение подтверждения оплаты, то статус оплаты будет равен "Да"
            **Подтверждён ли заказ?** - При добавлении это поле всегда заполнятся значением "Нет", если не написано в запросе иначе.

            Вот примерные варианты того, как могут быть названы колонки в запросе на обновление ячейки:
            **Клиент** - [ОАО, ЗАО, ПАО, организация, физическое лицо, юридическое лицо, компания], а так же все грамматические формы этих слов в русском языке
            **Столбец** - Этот столбец заполняется на основании того, что человеку нужно поменять.
            Если в запросе говорится о том, что оплата подвтерждена, то это значит, что нужно обновить значение в соответствующей ячейке столбца "Статус оплаты" на "Да"
            Если в запросе говорится о том, что заказ подвтерждён или о том, что сделка состоялась, то это значит, что нужно обновить значение в соответствующей ячейке столбца "Подтверждён ли заказ?" на "Да"

            Вот примерные варианты того, как могут быть названы колонки в запросе на удаление записи:
            **Клиент** - [ОАО, ЗАО, ПАО, организация, физическое лицо, юридическое лицо, компания], а так же все грамматические формы этих слов в русском языке
            **Курс** - [наш продукт, продукт], а так же все грамматические формы этих слов в русском языке

            Преобразуй следующую инструкцию в список JSON-команд для работы с таблицей.
            Доступные команды: add_row, update_cell, delete_row.

            **В запросе на добавление новой записи обязательно будет присутствовать ключевое слово, связанное с добавлением, например, добавь, добавить и так далее**
            **В запросе на обновление ячейки обязательно будет присутствовать ключевое слово, связанное с обновлением, например, обнови, обновить, изменить значение и так далее**
            **В запросе на удаление записи обязательно будет присутствовать ключевое слово, связанное с удали, например, удали, удалить, уничтожить, убрать из базы и так далее**

            Каждая команда должна иметь структуру: {"command": "<команда>", "parameters": {"ключ": "значение", ...}}.
            Верни только чистый JSON без дополнительного текста.\n\n"""
            f"Инструкция: {instruction}\n"
            """Примеры твоего ответа в JSON:
            Для добавления записи:
            {"command": "add_row", "parameters": {"клиент": "ООО Ромашка", "курс": "Фасад", "сумма": "10000", "статус оплаты": "Да", "Подтверждён ли заказ?": "Нет"}}
            Для обновления ячейки:
            {"command": "update_cell", "parameters": {"клиент": "ООО Ромашка", "столбец": "сумма", "значение": "20000"}}
            Для удаления строки:
            {"command": "delete_row", "parameters": {"клиент": "ООО Ромашка", "курс": "Фасад"}}
            Ответь **ТОЛЬКО** в формате JSON."""
        )

        response = await openai_client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {
                    "role": "system",
                    "content": "Ты помощник, преобразующий текст в JSON-команды.",
                },
                {"role": "user", "content": prompt},
            ],
            max_tokens=500,
            temperature=0.0,
        )

        commands_text = response.choices[0].message.content.strip()
        commands = json.loads(commands_text)
        return [commands] if isinstance(commands, dict) else commands

    except json.JSONDecodeError as e:
        logging.error(f"Ошибка парсинга JSON от OpenAI: {e}")
        return []
    except Exception as e:
        logging.error(f"Ошибка при запросе к OpenAI: {e}")
        return []

    # prompt = (
    #     """Ты помощник, преобразующий текст в JSON-команды.
    #     Твоя задача — анализировать инструкцию и сделать с ней следующее:
    #
    #     В запросе могут приходить различные названия колонок таблицы. То есть каждый человек может наывать их по-разному.
    #     Вот примерные варианты того, как могут быть названы колонки в запросе на добавление новой записи:
    #     **Клиент** - [ОАО, ЗАО, ПАО, организация, физическое лицо, юридическое лицо, компания], а так же все грамматические формы этих слов в русском языке
    #     **Курс** - [наш продукт, продукт], а так же все грамматические формы этих слов в русском языке
    #     **Сумма** - [стоимость, стоимость курсов, цена, ценник, цена курса, цена курсов, прайс]. Так же если в запросе пришли фразы по типу [курсы стоят, по цене, стоимостью], а дальше стоят цифры, то следует расценивать это как данные для графы "сумма"
    #     **Статус оплаты** - [подтверждение оплаты]. Если в запросе пришли фразы по типу [клиент оплатил, оплата подтвержена], то есть фразы, которые имеют значение подтверждения оплаты, то статус оплаты будет равен "Да"
    #     **Подтверждён ли заказ?** - При добавлении это поле всегда заполнятся значением "Нет", если не написано в запросе иначе.
    #
    #     Вот примерные варианты того, как могут быть названы колонки в запросе на обновление ячейки:
    #     **Клиент** - [ОАО, ЗАО, ПАО, организация, физическое лицо, юридическое лицо, компания], а так же все грамматические формы этих слов в русском языке
    #     **Столбец** - Этот столбец заполняется на основании того, что человеку нужно поменять.
    #     Если в запросе говорится о том, что оплата подвтерждена, то это значит, что нужно обновить значение в соответствующей ячейке столбца "Статус оплаты" на "Да"
    #     Если в запросе говорится о том, что заказ подвтерждён или о том, что сделка состоялась, то это значит, что нужно обновить значение в соответствующей ячейке столбца "Подтверждён ли заказ?" на "Да"
    #
    #     Вот примерные варианты того, как могут быть названы колонки в запросе на удаление записи:
    #     **Клиент** - [ОАО, ЗАО, ПАО, организация, физическое лицо, юридическое лицо, компания], а так же все грамматические формы этих слов в русском языке
    #     **Курс** - [наш продукт, продукт], а так же все грамматические формы этих слов в русском языке
    #
    #     Преобразуй следующую инструкцию в список JSON-команд для работы с таблицей.
    #     Доступные команды: add_row, update_cell, delete_row.
    #
    #     **В запросе на добавление новой записи обязательно будет присутствовать ключевое слово, связанное с добавлением, например, добавь, добавить и так далее**
    #     **В запросе на обновление ячейки обязательно будет присутствовать ключевое слово, связанное с обновлением, например, обнови, обновить, изменить значение и так далее**
    #     **В запросе на удаление записи обязательно будет присутствовать ключевое слово, связанное с удали, например, удали, удалить, уничтожить, убрать из базы и так далее**
    #
    #     Каждая команда должна иметь структуру: {"command": "<команда>", "parameters": {"ключ": "значение", ...}}.
    #     Верни только чистый JSON без дополнительного текста.\n\n"""
    #     f"Инструкция: {instruction}\n"
    #     """Примеры твоего ответа в JSON:
    #     Для добавления записи:
    #     {"command": "add_row", "parameters": {"клиент": "ООО Ромашка", "курс": "Фасад", "сумма": "10000", "статус оплаты": "Да", "Подтверждён ли заказ?": "Нет"}}
    #     Для обновления ячейки:
    #     {"command": "update_cell", "parameters": {"клиент": "ООО Ромашка", "столбец": "сумма", "значение": "20000"}}
    #     Для удаления строки:
    #     {"command": "delete_row", "parameters": {"клиент": "ООО Ромашка", "курс": "Фасад"}}
    #     Ответь **ТОЛЬКО** в формате JSON."""
    # )
    #
    # response = await openai_client.chat.completions.create(
    #     model="gpt-4o-mini",
    #     messages=[
    #         {"role": "system", "content": "Ты помощник, преобразующий текст в JSON-команды."},
    #         {"role": "user", "content": prompt}
    #     ],
    #     max_tokens=500,
    #     temperature=0.0
    # )
    #
    # commands_text = response.choices[0].message.content.strip()
    # # logging.error(f"JSON {response}")
    # commands = json.loads(commands_text)
    # return [commands] if isinstance(commands, dict) else commands
